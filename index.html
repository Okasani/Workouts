<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <meta name="theme-color" content="#09090b" />
  <title>FitTrack</title>

  <style>
    :root{
      --bg:#09090b;
      --card-bg:#18181b;
      --card-border:#27272a;
      --muted:#a1a1aa;
      --text:#f4f4f5;
      --primary:#3b82f6;
      --primary-hover:#2563eb;
      --danger:#ef4444;
      --success:#22c55e;
      --warn:#f59e0b;
      --radius:14px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      background: radial-gradient(1200px 700px at 30% -10%, rgba(59,130,246,.18), transparent 55%),
                  radial-gradient(1000px 600px at 80% 0%, rgba(34,197,94,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      padding-bottom: 90px;
    }

    .wrap{
      max-width:720px;
      margin:0 auto;
      padding:20px;
      display:flex;
      flex-direction:column;
      gap:18px;
    }

    /* Header */
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      padding-top:10px;
    }
    .brand h1{
      margin:0;
      font-size:28px;
      letter-spacing:-0.03em;
      background:linear-gradient(to right, #fff, #c7c7cf);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    .brand p{margin:6px 0 0;color:var(--muted);font-size:14px}

    .rightbar{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      display:flex;
      align-items:center;
      gap:10px;
      background:rgba(24,24,27,.85);
      border:1px solid rgba(39,39,42,.9);
      border-radius:999px;
      padding:10px 12px;
      backdrop-filter: blur(8px);
      box-shadow: 0 1px 0 rgba(255,255,255,.04) inset;
    }
    .pill .avatar{font-size:18px}
    .pill .hint{margin:0;font-size:11px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted)}
    .pill .name{margin:0;font-size:14px;font-weight:650}

    /* Buttons */
    .btn{
      border:none;
      border-radius:var(--radius);
      cursor:pointer;
      font-weight:650;
      font-family:var(--font);
      transition:.18s;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:12px 14px;
      user-select:none;
    }
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.primary:hover{background:var(--primary-hover)}
    .btn.secondary{
      background:rgba(39,39,42,.75);
      border:1px solid rgba(39,39,42,.95);
      color:var(--text);
    }
    .btn.secondary:hover{transform: translateY(-1px); border-color:#3f3f46}
    .btn.ghost{background:transparent;color:var(--muted);padding:10px 12px}
    .btn.ghost:hover{background:rgba(39,39,42,.75);color:var(--text)}
    .btn.danger{background:rgba(239,68,68,.12);color:var(--danger);border:1px solid rgba(239,68,68,.18)}
    .btn.danger:hover{background:rgba(239,68,68,.18)}
    .icon-btn{
      width:40px;height:40px;
      padding:0;
      border-radius:999px;
      background:transparent;
      color:var(--muted);
      border:1px solid rgba(39,39,42,.7);
    }
    .icon-btn:hover{background:rgba(39,39,42,.7);color:#fff}

    /* Inputs */
    .input{
      width:100%;
      padding:14px 14px;
      border-radius:var(--radius);
      border:1px solid rgba(39,39,42,.95);
      background:rgba(39,39,42,.55);
      color:var(--text);
      font-size:16px;
      outline:none;
      transition:.18s;
      font-family:var(--font);
    }
    .input:focus{border-color:rgba(59,130,246,.9); box-shadow: 0 0 0 3px rgba(59,130,246,.18);}
    textarea.input{min-height:140px;resize:vertical;line-height:1.5}

    :focus-visible{outline:2px solid rgba(59,130,246,.75); outline-offset:2px; border-radius:10px}

    /* Cards */
    .card{
      background:rgba(24,24,27,.9);
      border:1px solid rgba(39,39,42,.95);
      border-radius:var(--radius);
      padding:18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }

    /* Progress */
    .progress-header{display:flex;justify-content:space-between;gap:10px;font-size:13px;color:var(--muted);font-weight:550;margin-bottom:10px}
    .progress-bar-bg{height:8px;background:rgba(39,39,42,.85);border-radius:999px;overflow:hidden}
    .progress-bar-fill{height:100%;width:0%;background:var(--success);transition:width .35s ease;border-radius:999px}

    /* Add Trigger */
    .add-trigger{
      width:100%;
      border-radius:var(--radius);
      padding:18px;
      cursor:pointer;
      border:1px dashed rgba(63,63,70,.95);
      background:rgba(39,39,42,.25);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      color:var(--muted);
      transition:.18s;
      font-weight:650;
    }
    .add-trigger:hover{
      border-color:rgba(59,130,246,.9);
      background:rgba(59,130,246,.07);
      color:var(--primary);
      transform: translateY(-1px);
    }
    .plus{font-size:18px; font-weight:800}

    /* Toolbar */
    .toolbar{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:space-between;
      margin-top:8px;
    }
    .toolbar .left, .toolbar .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      border:1px solid rgba(39,39,42,.95);
      background:rgba(39,39,42,.45);
      color:var(--muted);
      padding:8px 10px;
      border-radius:999px;
      font-size:13px;
      cursor:pointer;
      user-select:none;
      transition:.18s;
    }
    .chip:hover{border-color:#3f3f46;color:var(--text)}
    .chip.active{
      border-color:rgba(59,130,246,.75);
      color:#fff;
      background:rgba(59,130,246,.14);
    }

    /* List */
    .listHeader{display:flex;justify-content:space-between;align-items:center;margin:14px 0 10px}
    .listHeader h2{margin:0;font-size:18px}
    .list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:10px}

    .item{
      display:flex;
      align-items:center;
      gap:12px;
      padding:14px;
      border-radius:var(--radius);
      border:1px solid rgba(39,39,42,.95);
      background:rgba(39,39,42,.25);
      transition:.18s;
    }
    .item:hover{border-color:#52525b}
    .item.done{opacity:.7; border-style:dashed; background:transparent}
    .item.done .name{text-decoration:line-through;color:var(--muted)}

    .check-wrap{position:relative;width:22px;height:22px;flex:0 0 22px}
    .check{
      opacity:0;
      width:22px;height:22px;
      position:absolute;inset:0;z-index:2;margin:0;cursor:pointer;
    }
    .custom-check{
      width:22px;height:22px;border-radius:7px;border:2px solid #52525b;
      display:flex;align-items:center;justify-content:center;
      transition:.18s;background:transparent;
      position:absolute;inset:0;pointer-events:none;
    }
    .check:checked + .custom-check{background:var(--success);border-color:var(--success)}
    .check:checked + .custom-check::after{content:"‚úî";font-size:14px;color:#06110a}

    .item-content{flex:1;min-width:0;display:flex;flex-direction:column;gap:4px}
    .name{font-size:15px;font-weight:650;word-break:break-word}
    .meta{font-size:12px;color:var(--muted)}
    .mini-bar{height:6px;background:rgba(39,39,42,.85);border-radius:999px;overflow:hidden;margin-top:6px}
    .mini-fill{height:100%;width:0%;background:rgba(34,197,94,.95);transition:width .25s ease}

    .actions{display:flex;gap:6px;align-items:center}
    .action-btn{
      border:none;
      background:transparent;
      color:var(--muted);
      width:34px;height:34px;
      border-radius:10px;
      cursor:pointer;
      transition:.18s;
      display:flex;align-items:center;justify-content:center;
      border:1px solid transparent;
    }
    .action-btn:hover{background:rgba(63,63,70,.55);color:#fff;border-color:rgba(39,39,42,.6)}
    .action-btn.delete:hover{background:rgba(239,68,68,.14);color:var(--danger);border-color:rgba(239,68,68,.2)}
    .action-btn.warn:hover{background:rgba(245,158,11,.14);color:var(--warn);border-color:rgba(245,158,11,.2)}

    .empty{padding:34px 0;text-align:center;color:var(--muted)}
    .empty .emoji{font-size:40px;opacity:.6;margin-bottom:10px}

    .hidden{display:none !important}

    /* Modals */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.7);
      backdrop-filter: blur(6px);
      display:flex;align-items:center;justify-content:center;
      z-index:100;
      padding:18px;
    }
    .modal{
      width:100%;
      max-width:420px;
      background:rgba(24,24,27,.96);
      border:1px solid rgba(39,39,42,.95);
      border-radius:18px;
      padding:18px;
      box-shadow: var(--shadow);
    }
    .modal h3{margin:0 0 10px;font-size:18px}
    .modal p{margin:0 0 12px;color:var(--muted);font-size:13px;line-height:1.45}
    .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:14px;flex-wrap:wrap}

    /* Toast */
    .toasts{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:16px;
      width:min(720px, calc(100% - 24px));
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:200;
      pointer-events:none;
    }
    .toast{
      pointer-events:auto;
      background:rgba(24,24,27,.96);
      border:1px solid rgba(39,39,42,.95);
      border-radius:16px;
      padding:12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      box-shadow: var(--shadow);
    }
    .toast .msg{color:var(--text);font-size:14px}
    .toast .toast-actions{display:flex;gap:8px;align-items:center}

    /* Detail */
    .back{
      display:inline-flex;align-items:center;gap:10px;
      color:var(--muted);cursor:pointer;
      padding:10px 0;
      user-select:none;
    }
    .back:hover{color:var(--primary)}

    .tag{
      display:inline-flex;
      gap:8px;
      align-items:center;
      font-size:12px;
      color:var(--primary);
      background:rgba(59,130,246,.12);
      border:1px solid rgba(59,130,246,.18);
      padding:6px 10px;
      border-radius:999px;
      margin-top:10px;
      width:max-content;
    }

    @media (max-width: 520px){
      .topbar{flex-direction:column;align-items:flex-start}
      .rightbar{width:100%;justify-content:space-between}
      .pill{width:100%;justify-content:space-between}
    }

    @media (prefers-reduced-motion: reduce){
      *{transition:none !important; animation:none !important}
    }
  </style>
</head>

<body>
<main class="wrap">
  <!-- HOME VIEW -->
  <section id="homeView">
    <header class="topbar">
      <div class="brand">
        <h1>FitTrack</h1>
        <p>Organize your sessions. Paste workouts. Track progress.</p>
      </div>

      <div class="rightbar">
        <div class="pill" aria-label="Profile">
          <span class="avatar" aria-hidden="true">üí™</span>
          <div>
            <p class="hint">Welcome back,</p>
            <p class="name" id="helloName">Athlete</p>
          </div>
          <button class="btn icon-btn" id="editNameBtn" title="Edit Name" aria-label="Edit Name">
            ‚úé
          </button>
        </div>

        <button class="btn secondary" id="exportBtn" title="Export backup JSON">
          ‚§ì Export
        </button>
        <button class="btn secondary" id="importBtn" title="Import backup JSON">
          ‚§í Import
        </button>
      </div>
    </header>

    <section class="card" aria-label="Overall completion">
      <div class="progress-header">
        <span>Total Completion</span>
        <span id="homeProgressText">0%</span>
      </div>
      <div class="progress-bar-bg">
        <div id="homeProgressBar" class="progress-bar-fill"></div>
      </div>

      <div class="toolbar">
        <div class="left" style="flex:1; min-width:220px;">
          <input class="input" id="sessionSearch" placeholder="Search sessions‚Ä¶ (press /)" autocomplete="off" />
        </div>
        <div class="right">
          <div class="chips" aria-label="Session filter">
            <button class="chip active" data-filter="all" id="sessionFilterAll">All</button>
            <button class="chip" data-filter="active" id="sessionFilterActive">Active</button>
            <button class="chip" data-filter="done" id="sessionFilterDone">Done</button>
          </div>
          <button class="btn danger" id="clearAllBtn" title="Clear all data">Reset</button>
        </div>
      </div>
    </section>

    <button id="openAddSessionModalBtn" class="add-trigger" style="margin-top:6px;">
      <span class="plus" aria-hidden="true">+</span>
      <span>Create New Session</span>
      <span style="margin-left:auto;color:var(--muted);font-weight:600;font-size:12px;">(N)</span>
    </button>

    <section class="card">
      <div class="listHeader">
        <h2>Your Sessions</h2>
        <span class="meta" id="sessionCountLabel">0 sessions</span>
      </div>

      <ul id="sessionList" class="list" aria-live="polite"></ul>

      <div id="emptySessions" class="empty">
        <div class="emoji" aria-hidden="true">üìÅ</div>
        <div>No sessions yet.</div>
        <div style="margin-top:6px;">Try ‚ÄúLeg Day‚Äù, ‚ÄúPush‚Äù, ‚ÄúPull‚Äù, ‚ÄúFull Body‚Äù.</div>
      </div>
    </section>
  </section>

  <!-- DETAIL VIEW -->
  <section id="detailView" class="hidden">
    <div class="back" id="backBtn" role="button" tabindex="0" aria-label="Back to sessions">
      ‚Üê Back to Sessions
    </div>

    <section class="card">
      <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px;">
        <div>
          <h2 id="detailTitle" style="margin:0; font-size:22px; letter-spacing:-.02em;">Session</h2>
          <div class="tag">Editing Exercises</div>
        </div>

        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
          <button class="btn secondary" id="renameSessionBtn" title="Rename session">Rename</button>
          <button class="btn secondary" id="duplicateSessionBtn" title="Duplicate session">Duplicate</button>
          <button class="btn danger" id="deleteSessionBtn" title="Delete session">Delete</button>
        </div>
      </div>

      <div style="margin-top:14px;">
        <div class="progress-header">
          <span>Session Progress</span>
          <span id="detailProgressText">0%</span>
        </div>
        <div class="progress-bar-bg">
          <div id="detailProgressBar" class="progress-bar-fill"></div>
        </div>

        <div class="toolbar">
          <div class="left" style="flex:1; min-width:220px;">
            <input class="input" id="exerciseSearch" placeholder="Search exercises‚Ä¶" autocomplete="off" />
          </div>
          <div class="right">
            <div class="chips" aria-label="Exercise filter">
              <button class="chip active" data-exfilter="all" id="exFilterAll">All</button>
              <button class="chip" data-exfilter="active" id="exFilterActive">Active</button>
              <button class="chip" data-exfilter="done" id="exFilterDone">Done</button>
            </div>
            <button class="btn secondary" id="markAllDoneBtn" title="Mark all exercises done">‚úì All</button>
            <button class="btn secondary" id="clearDoneBtn" title="Remove completed exercises">Clear Done</button>
          </div>
        </div>
      </div>
    </section>

    <button id="openAddExerciseModalBtn" class="add-trigger" style="margin-top:6px;">
      <span class="plus" aria-hidden="true">+</span>
      <span>Add Exercises (Paste List)</span>
      <span style="margin-left:auto;color:var(--muted);font-weight:600;font-size:12px;">(E)</span>
    </button>

    <section class="card">
      <div class="listHeader">
        <h2>Exercises</h2>
        <span class="meta" id="exerciseCountLabel">0 items</span>
      </div>

      <ul id="exerciseList" class="list" aria-live="polite"></ul>

      <div id="emptyExercises" class="empty">
        <div class="emoji" aria-hidden="true">üìù</div>
        <div>Empty session.</div>
        <div style="margin-top:6px;">Paste a workout list to get started.</div>
      </div>
    </section>
  </section>

  <!-- Modals -->
  <div id="nameModal" class="overlay hidden" role="dialog" aria-modal="true" aria-labelledby="nameModalTitle">
    <div class="modal">
      <h3 id="nameModalTitle">Your Profile Name</h3>
      <p>This name is saved locally on your device.</p>
      <input id="userNameInput" class="input" placeholder="e.g., Poom" autocomplete="name" />
      <div class="modal-actions">
        <button class="btn ghost" data-close="nameModal">Cancel</button>
        <button class="btn primary" id="saveNameBtn">Save</button>
      </div>
    </div>
  </div>

  <div id="addSessionModal" class="overlay hidden" role="dialog" aria-modal="true" aria-labelledby="addSessionTitle">
    <div class="modal">
      <h3 id="addSessionTitle">New Session</h3>
      <p>Example: ‚ÄúLeg Day‚Äù, ‚ÄúPush‚Äù, ‚ÄúPull‚Äù, ‚ÄúAbs‚Äù, ‚ÄúCardio‚Äù.</p>
      <input id="newSessionInput" class="input" placeholder="Session name" autocomplete="off" />
      <div class="modal-actions">
        <button class="btn ghost" data-close="addSessionModal">Cancel</button>
        <button class="btn primary" id="confirmAddSessionBtn">Create</button>
      </div>
    </div>
  </div>

  <div id="addExerciseModal" class="overlay hidden" role="dialog" aria-modal="true" aria-labelledby="addExerciseTitle">
    <div class="modal" style="max-width:520px;">
      <h3 id="addExerciseTitle">Paste Exercises</h3>
      <p>Each new line becomes an item. Bullets and numbering are cleaned automatically.</p>
      <textarea id="newExerciseInput" class="input" placeholder="Push Ups 3x10&#10;Squats 3x10&#10;Plank 30s"></textarea>
      <div class="modal-actions">
        <button class="btn ghost" data-close="addExerciseModal">Cancel</button>
        <button class="btn primary" id="confirmAddExerciseBtn">Add</button>
      </div>
    </div>
  </div>

  <div id="confirmModal" class="overlay hidden" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="modal">
      <h3 id="confirmTitle">Confirm</h3>
      <p id="confirmText">Are you sure?</p>
      <div class="modal-actions">
        <button class="btn ghost" id="confirmCancelBtn">Cancel</button>
        <button class="btn danger" id="confirmOkBtn">Delete</button>
      </div>
    </div>
  </div>

  <input id="importFile" type="file" accept="application/json" class="hidden" />
</main>

<div class="toasts" id="toasts" aria-live="polite" aria-atomic="true"></div>

<script>
(() => {
  const STORAGE_KEY = "fittrack_v7_consumer";
  const $ = (id) => document.getElementById(id);

  // --- Elements ---
  const els = {
    homeView: $("homeView"),
    detailView: $("detailView"),
    helloName: $("helloName"),

    // Progress
    homeProgressBar: $("homeProgressBar"),
    homeProgressText: $("homeProgressText"),
    detailProgressBar: $("detailProgressBar"),
    detailProgressText: $("detailProgressText"),

    // Lists
    sessionList: $("sessionList"),
    exerciseList: $("exerciseList"),
    emptySessions: $("emptySessions"),
    emptyExercises: $("emptyExercises"),
    sessionCountLabel: $("sessionCountLabel"),
    exerciseCountLabel: $("exerciseCountLabel"),

    // Search + filters
    sessionSearch: $("sessionSearch"),
    exerciseSearch: $("exerciseSearch"),
    sessionFilterAll: $("sessionFilterAll"),
    sessionFilterActive: $("sessionFilterActive"),
    sessionFilterDone: $("sessionFilterDone"),
    exFilterAll: $("exFilterAll"),
    exFilterActive: $("exFilterActive"),
    exFilterDone: $("exFilterDone"),

    // Buttons
    editNameBtn: $("editNameBtn"),
    saveNameBtn: $("saveNameBtn"),
    openAddSessionModalBtn: $("openAddSessionModalBtn"),
    confirmAddSessionBtn: $("confirmAddSessionBtn"),
    openAddExerciseModalBtn: $("openAddExerciseModalBtn"),
    confirmAddExerciseBtn: $("confirmAddExerciseBtn"),
    backBtn: $("backBtn"),

    renameSessionBtn: $("renameSessionBtn"),
    duplicateSessionBtn: $("duplicateSessionBtn"),
    deleteSessionBtn: $("deleteSessionBtn"),
    markAllDoneBtn: $("markAllDoneBtn"),
    clearDoneBtn: $("clearDoneBtn"),

    exportBtn: $("exportBtn"),
    importBtn: $("importBtn"),
    importFile: $("importFile"),
    clearAllBtn: $("clearAllBtn"),

    // Detail title
    detailTitle: $("detailTitle"),

    // Modals
    nameModal: $("nameModal"),
    addSessionModal: $("addSessionModal"),
    addExerciseModal: $("addExerciseModal"),
    confirmModal: $("confirmModal"),
    userNameInput: $("userNameInput"),
    newSessionInput: $("newSessionInput"),
    newExerciseInput: $("newExerciseInput"),
    confirmText: $("confirmText"),
    confirmCancelBtn: $("confirmCancelBtn"),
    confirmOkBtn: $("confirmOkBtn"),

    // Toasts
    toasts: $("toasts"),
  };

  // --- State ---
  let state = {
    name: "Athlete",
    activeSessionId: null,
    sessions: [],
    ui: {
      sessionFilter: "all",
      sessionQuery: "",
      exFilter: "all",
      exQuery: ""
    }
  };

  let confirmAction = null;
  let undoStack = null; // { label, undoFn }

  // --- Utils ---
  function uid() {
    if (crypto?.randomUUID) return crypto.randomUUID();
    return Date.now().toString(36) + Math.random().toString(36).slice(2);
  }

  function safeGet(key) {
    try { return localStorage.getItem(key); } catch { return null; }
  }
  function safeSet(key, val) {
    try { localStorage.setItem(key, val); } catch {}
  }

  function loadState() {
    const raw = safeGet(STORAGE_KEY);
    if (!raw) return;
    try {
      const parsed = JSON.parse(raw);
      state.name = parsed.name || "Athlete";
      state.sessions = Array.isArray(parsed.sessions) ? parsed.sessions : [];
      state.activeSessionId = parsed.activeSessionId || null;
      state.ui = Object.assign(state.ui, parsed.ui || {});
    } catch {}
  }

  function saveState() {
    const payload = {
      name: state.name,
      sessions: state.sessions,
      activeSessionId: state.activeSessionId,
      ui: state.ui,
      updatedAt: new Date().toISOString()
    };
    safeSet(STORAGE_KEY, JSON.stringify(payload));
  }

  function clampPct(n) {
    n = Number.isFinite(n) ? n : 0;
    return Math.max(0, Math.min(100, n));
  }

  function sessionStats(session) {
    const ex = Array.isArray(session.exercises) ? session.exercises : [];
    const total = ex.length;
    const done = ex.filter(e => e.done).length;
    const pct = total ? Math.round((done / total) * 100) : 0;
    return { total, done, pct };
  }

  function overallSessionsCompletion() {
    const total = state.sessions.length;
    const done = state.sessions.filter(s => s.done).length;
    const pct = total ? Math.round((done / total) * 100) : 0;
    return { total, done, pct };
  }

  function setChipGroup(group, activeId) {
    const ids = group === "session"
      ? ["sessionFilterAll","sessionFilterActive","sessionFilterDone"]
      : ["exFilterAll","exFilterActive","exFilterDone"];
    ids.forEach(id => $(id).classList.remove("active"));
    $(activeId).classList.add("active");
  }

  function openModal(modalEl) {
    modalEl.classList.remove("hidden");
    // focus first input/textarea/button
    const focusable = modalEl.querySelector("input, textarea, button");
    if (focusable) setTimeout(() => focusable.focus(), 0);
  }
  function closeModal(modalEl) {
    modalEl.classList.add("hidden");
  }
  function closeAllModals() {
    [els.nameModal, els.addSessionModal, els.addExerciseModal, els.confirmModal].forEach(closeModal);
    confirmAction = null;
  }

  function showConfirm({ text, okText="Delete", danger=true, onOk }) {
    els.confirmText.textContent = text;
    els.confirmOkBtn.textContent = okText;
    els.confirmOkBtn.className = "btn " + (danger ? "danger" : "primary");
    confirmAction = onOk;
    openModal(els.confirmModal);
  }

  function toast(message, opts={}) {
    const { actionText, onAction, timeout=4200 } = opts;

    const t = document.createElement("div");
    t.className = "toast";

    const msg = document.createElement("div");
    msg.className = "msg";
    msg.textContent = message;

    const right = document.createElement("div");
    right.className = "toast-actions";

    if (actionText && typeof onAction === "function") {
      const a = document.createElement("button");
      a.className = "btn secondary";
      a.style.padding = "10px 12px";
      a.textContent = actionText;
      a.onclick = () => {
        try { onAction(); } finally {
          t.remove();
        }
      };
      right.appendChild(a);
    }

    const x = document.createElement("button");
    x.className = "btn ghost";
    x.style.padding = "10px 12px";
    x.textContent = "√ó";
    x.onclick = () => t.remove();
    right.appendChild(x);

    t.append(msg, right);
    els.toasts.appendChild(t);

    if (timeout) {
      setTimeout(() => { if (t.isConnected) t.remove(); }, timeout);
    }
  }

  // Clean pasted lines:
  // - remove bullets: "- ", "* ", "‚Ä¢ "
  // - remove numbering: "1. ", "1) "
  // - trim
  function smartParseList(raw) {
    if (!raw) return [];
    let text = raw.replace(/\r/g, "").trim();
    if (!text) return [];

    let lines = text.split("\n");
    // If user pasted a single line with semicolons, split that too
    if (lines.length === 1 && /;/.test(lines[0])) {
      lines = lines[0].split(";");
    }

    const out = [];
    const seen = new Set();

    for (let line of lines) {
      let s = (line || "").trim();
      if (!s) continue;
      s = s.replace(/^[-*‚Ä¢]\s+/, "");           // bullets
      s = s.replace(/^\d+[\.\)]\s+/, "");       // numbering
      s = s.replace(/\s{2,}/g, " ").trim();     // normalize spaces
      if (!s) continue;

      const key = s.toLowerCase();
      if (seen.has(key)) continue;
      seen.add(key);
      out.push(s);
    }
    return out;
  }

  // --- Rendering ---
  function setView(view) {
    const isDetail = view === "detail";
    els.homeView.classList.toggle("hidden", isDetail);
    els.detailView.classList.toggle("hidden", !isDetail);
  }

  function getActiveSession() {
    return state.sessions.find(s => s.id === state.activeSessionId) || null;
  }

  function filteredSessions() {
    const q = (state.ui.sessionQuery || "").toLowerCase().trim();
    const f = state.ui.sessionFilter;

    return state.sessions.filter(s => {
      const matchesQuery = !q || (s.text || "").toLowerCase().includes(q);
      const matchesFilter =
        f === "all" ? true :
        f === "active" ? !s.done :
        f === "done" ? !!s.done :
        true;
      return matchesQuery && matchesFilter;
    });
  }

  function filteredExercises(session) {
    const ex = Array.isArray(session.exercises) ? session.exercises : [];
    const q = (state.ui.exQuery || "").toLowerCase().trim();
    const f = state.ui.exFilter;

    return ex.filter(e => {
      const matchesQuery = !q || (e.text || "").toLowerCase().includes(q);
      const matchesFilter =
        f === "all" ? true :
        f === "active" ? !e.done :
        f === "done" ? !!e.done :
        true;
      return matchesQuery && matchesFilter;
    });
  }

  function renderHome() {
    setView("home");

    els.helloName.textContent = state.name;
    els.sessionSearch.value = state.ui.sessionQuery || "";

    const overall = overallSessionsCompletion();
    const pct = clampPct(overall.pct);

    els.homeProgressBar.style.width = pct + "%";
    els.homeProgressText.textContent = pct + "%";
    els.homeProgressText.style.color = (pct === 100 && overall.total > 0) ? "var(--success)" : "var(--muted)";

    // Count label
    els.sessionCountLabel.textContent = `${state.sessions.length} session${state.sessions.length === 1 ? "" : "s"}`;

    // List
    const list = filteredSessions();
    els.sessionList.innerHTML = "";
    els.emptySessions.classList.toggle("hidden", state.sessions.length > 0);

    if (list.length === 0 && state.sessions.length > 0) {
      // user has sessions but filter/search hides them
      const hint = document.createElement("div");
      hint.className = "empty";
      hint.innerHTML = `<div class="emoji" aria-hidden="true">üîé</div><div>No matches.</div><div style="margin-top:6px;">Try clearing search / filters.</div>`;
      els.sessionList.appendChild(hint);
      return;
    }

    const frag = document.createDocumentFragment();

    list.forEach(session => {
      const li = document.createElement("li");
      li.className = "item" + (session.done ? " done" : "");
      li.setAttribute("role", "button");
      li.tabIndex = 0;

      // checkbox
      const cwrap = document.createElement("div");
      cwrap.className = "check-wrap";
      cwrap.onclick = (e) => e.stopPropagation();

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.className = "check";
      cb.checked = !!session.done;
      cb.setAttribute("aria-label", "Mark session done");

      const cc = document.createElement("div");
      cc.className = "custom-check";
      cb.onchange = () => {
        session.done = cb.checked;
        saveState();
        render();
      };
      cwrap.append(cb, cc);

      // content
      const content = document.createElement("div");
      content.className = "item-content";
      const name = document.createElement("div");
      name.className = "name";
      name.textContent = session.text || "Untitled";

      const stats = sessionStats(session);
      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = stats.total
        ? `${stats.done}/${stats.total} done`
        : `0 exercises`;

      const mini = document.createElement("div");
      mini.className = "mini-bar";
      const fill = document.createElement("div");
      fill.className = "mini-fill";
      fill.style.width = clampPct(stats.pct) + "%";
      mini.appendChild(fill);

      content.append(name, meta, mini);

      // actions
      const actions = document.createElement("div");
      actions.className = "actions";
      actions.onclick = (e) => e.stopPropagation();

      const rename = document.createElement("button");
      rename.className = "action-btn";
      rename.title = "Rename";
      rename.textContent = "‚úé";
      rename.onclick = () => renameSession(session.id);

      const dup = document.createElement("button");
      dup.className = "action-btn warn";
      dup.title = "Duplicate";
      dup.textContent = "‚éò";
      dup.onclick = () => duplicateSession(session.id);

      const del = document.createElement("button");
      del.className = "action-btn delete";
      del.title = "Delete";
      del.textContent = "üóë";
      del.onclick = () => deleteSession(session.id);

      actions.append(rename, dup, del);

      // open detail
      li.onclick = () => {
        state.activeSessionId = session.id;
        saveState();
        render();
      };
      li.onkeydown = (e) => {
        if (e.key === "Enter") li.click();
      };

      li.append(cwrap, content, actions);
      frag.appendChild(li);
    });

    els.sessionList.appendChild(frag);
  }

  function renderDetail() {
    const session = getActiveSession();
    if (!session) {
      state.activeSessionId = null;
      saveState();
      renderHome();
      return;
    }

    setView("detail");
    els.detailTitle.textContent = session.text || "Session";

    els.exerciseSearch.value = state.ui.exQuery || "";

    const ex = Array.isArray(session.exercises) ? session.exercises : [];
    const done = ex.filter(e => e.done).length;
    const total = ex.length;
    const pct = total ? Math.round((done / total) * 100) : 0;

    els.detailProgressBar.style.width = clampPct(pct) + "%";
    els.detailProgressText.textContent = clampPct(pct) + "%";
    els.detailProgressText.style.color = (pct === 100 && total > 0) ? "var(--success)" : "var(--muted)";

    els.exerciseCountLabel.textContent = `${total} item${total === 1 ? "" : "s"}`;

    const list = filteredExercises(session);
    els.exerciseList.innerHTML = "";
    els.emptyExercises.classList.toggle("hidden", total > 0);

    if (list.length === 0 && total > 0) {
      const hint = document.createElement("div");
      hint.className = "empty";
      hint.innerHTML = `<div class="emoji" aria-hidden="true">üîé</div><div>No matches.</div><div style="margin-top:6px;">Try clearing search / filters.</div>`;
      els.exerciseList.appendChild(hint);
      return;
    }

    const frag = document.createDocumentFragment();

    list.forEach(exItem => {
      const li = document.createElement("li");
      li.className = "item" + (exItem.done ? " done" : "");

      // checkbox
      const cwrap = document.createElement("div");
      cwrap.className = "check-wrap";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.className = "check";
      cb.checked = !!exItem.done;
      cb.setAttribute("aria-label", "Mark exercise done");

      const cc = document.createElement("div");
      cc.className = "custom-check";

      cb.onchange = () => {
        exItem.done = cb.checked;
        // if all exercises done, optionally mark session done (nice UX)
        session.done = total > 0 && session.exercises.every(x => x.done);
        saveState();
        render();
      };

      cwrap.append(cb, cc);

      // content
      const content = document.createElement("div");
      content.className = "item-content";

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = exItem.text || "Exercise";

      content.appendChild(name);

      // actions
      const actions = document.createElement("div");
      actions.className = "actions";

      const edit = document.createElement("button");
      edit.className = "action-btn";
      edit.title = "Edit";
      edit.textContent = "‚úé";
      edit.onclick = () => editExerciseInline(session, exItem, content, actions);

      const del = document.createElement("button");
      del.className = "action-btn delete";
      del.title = "Delete";
      del.textContent = "üóë";
      del.onclick = () => deleteExercise(session, exItem.id);

      actions.append(edit, del);

      li.append(cwrap, content, actions);
      frag.appendChild(li);
    });

    els.exerciseList.appendChild(frag);
  }

  function render() {
    els.helloName.textContent = state.name;

    if (state.activeSessionId) renderDetail();
    else renderHome();
  }

  // --- Actions ---
  function createSession(name) {
    const text = (name || "").trim();
    if (!text) return;

    state.sessions.unshift({ id: uid(), text, done: false, exercises: [] });
    saveState();
    render();
    toast(`Created session: ${text}`);
  }

  function renameSession(sessionId) {
    const s = state.sessions.find(x => x.id === sessionId);
    if (!s) return;

    // reuse addSessionModal UI for rename
    els.newSessionInput.value = s.text || "";
    openModal(els.addSessionModal);

    const oldHandler = els.confirmAddSessionBtn.onclick;
    els.confirmAddSessionBtn.onclick = () => {
      const val = els.newSessionInput.value.trim();
      if (val) {
        s.text = val;
        saveState();
        render();
        toast("Session renamed");
        closeModal(els.addSessionModal);
        els.confirmAddSessionBtn.onclick = oldHandler;
      }
    };
  }

  function duplicateSession(sessionId) {
    const s = state.sessions.find(x => x.id === sessionId);
    if (!s) return;

    const copy = JSON.parse(JSON.stringify(s));
    copy.id = uid();
    copy.text = (s.text || "Session") + " (Copy)";
    if (Array.isArray(copy.exercises)) {
      copy.exercises = copy.exercises.map(e => ({...e, id: uid()}));
    } else {
      copy.exercises = [];
    }
    state.sessions.unshift(copy);
    saveState();
    render();
    toast("Session duplicated");
  }

  function deleteSession(sessionId) {
    const s = state.sessions.find(x => x.id === sessionId);
    if (!s) return;

    showConfirm({
      text: `Delete session "${s.text}"? This removes its exercises too.`,
      okText: "Delete",
      danger: true,
      onOk: () => {
        const snapshot = JSON.parse(JSON.stringify(s));
        state.sessions = state.sessions.filter(x => x.id !== sessionId);
        if (state.activeSessionId === sessionId) state.activeSessionId = null;
        saveState();
        render();

        undoStack = {
          label: "Undo delete",
          undoFn: () => {
            state.sessions.unshift(snapshot);
            saveState();
            render();
            toast("Restored session");
          }
        };

        toast("Session deleted", { actionText: "Undo", onAction: () => undoStack?.undoFn?.() });
        closeModal(els.confirmModal);
      }
    });
  }

  function editExerciseInline(session, exItem, contentDiv, actionsDiv) {
    const input = document.createElement("input");
    input.className = "input";
    input.style.padding = "12px 12px";
    input.value = exItem.text || "";
    contentDiv.innerHTML = "";
    contentDiv.appendChild(input);
    actionsDiv.style.display = "none";
    input.focus();

    const commit = () => {
      const val = input.value.trim();
      if (val) exItem.text = val;
      saveState();
      render();
    };
    input.onblur = commit;
    input.onkeydown = (e) => {
      if (e.key === "Enter") commit();
      if (e.key === "Escape") render();
    };
  }

  function deleteExercise(session, exId) {
    const ex = (session.exercises || []).find(e => e.id === exId);
    if (!ex) return;

    showConfirm({
      text: `Delete "${ex.text}"?`,
      okText: "Delete",
      danger: true,
      onOk: () => {
        const snapshot = JSON.parse(JSON.stringify(ex));
        session.exercises = (session.exercises || []).filter(e => e.id !== exId);
        saveState();
        render();

        undoStack = {
          label: "Undo delete",
          undoFn: () => {
            session.exercises.unshift(snapshot);
            saveState();
            render();
            toast("Restored exercise");
          }
        };

        toast("Exercise deleted", { actionText: "Undo", onAction: () => undoStack?.undoFn?.() });
        closeModal(els.confirmModal);
      }
    });
  }

  function addExercisesFromPaste(rawText) {
    const session = getActiveSession();
    if (!session) return;

    const lines = smartParseList(rawText);
    if (!lines.length) return;

    if (!Array.isArray(session.exercises)) session.exercises = [];

    lines.forEach(line => {
      session.exercises.push({ id: uid(), text: line, done: false });
    });

    // if user adds exercises, session likely not "done" anymore
    session.done = session.exercises.length > 0 && session.exercises.every(x => x.done);

    saveState();
    render();
    toast(`Added ${lines.length} exercise${lines.length === 1 ? "" : "s"}`);
  }

  function exportBackup() {
    const payload = {
      app: "FitTrack",
      version: 7,
      exportedAt: new Date().toISOString(),
      data: {
        name: state.name,
        sessions: state.sessions
      }
    };

    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `fittrack-backup-${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    toast("Exported backup JSON");
  }

  function importBackupFromFile(file) {
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      try {
        const parsed = JSON.parse(String(reader.result || ""));
        const data = parsed?.data || parsed; // allow importing raw old format

        const nextName = (data.name || "Athlete").toString();
        const nextSessions = Array.isArray(data.sessions) ? data.sessions : [];

        // Light validation: ensure ids exist
        nextSessions.forEach(s => {
          if (!s.id) s.id = uid();
          if (!Array.isArray(s.exercises)) s.exercises = [];
          s.exercises.forEach(e => { if (!e.id) e.id = uid(); });
        });

        state.name = nextName;
        state.sessions = nextSessions;
        state.activeSessionId = null;
        saveState();
        render();
        toast("Imported backup");
      } catch {
        toast("Import failed (invalid JSON)", { timeout: 5000 });
      }
    };
    reader.readAsText(file);
  }

  // --- Events ---
  // modal close (buttons)
  document.addEventListener("click", (e) => {
    const btn = e.target.closest("[data-close]");
    if (!btn) return;
    const id = btn.getAttribute("data-close");
    const modal = $(id);
    if (modal) closeModal(modal);
  });

  // click outside modal to close
  [els.nameModal, els.addSessionModal, els.addExerciseModal, els.confirmModal].forEach(modal => {
    modal.addEventListener("mousedown", (e) => {
      if (e.target === modal) closeModal(modal);
    });
  });

  // ESC closes
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      closeAllModals();
      return;
    }
    // Quick shortcuts (avoid when typing)
    const tag = (document.activeElement?.tagName || "").toLowerCase();
    const typing = tag === "input" || tag === "textarea";
    if (typing) return;

    if (e.key === "/") {
      e.preventDefault();
      (state.activeSessionId ? els.exerciseSearch : els.sessionSearch).focus();
    }
    if (e.key.toLowerCase() === "n" && !state.activeSessionId) {
      openModal(els.addSessionModal);
      els.newSessionInput.value = "";
      els.newSessionInput.focus();
    }
    if (e.key.toLowerCase() === "e" && state.activeSessionId) {
      openModal(els.addExerciseModal);
      els.newExerciseInput.value = "";
      els.newExerciseInput.focus();
    }
  });

  // Name
  els.editNameBtn.onclick = () => {
    els.userNameInput.value = state.name;
    openModal(els.nameModal);
  };
  els.saveNameBtn.onclick = () => {
    const val = els.userNameInput.value.trim();
    if (val) {
      state.name = val;
      saveState();
      render();
      toast("Name saved");
    }
    closeModal(els.nameModal);
  };

  // Add Session
  els.openAddSessionModalBtn.onclick = () => {
    els.newSessionInput.value = "";
    openModal(els.addSessionModal);
  };
  els.confirmAddSessionBtn.onclick = () => {
    const text = els.newSessionInput.value.trim();
    if (!text) return;
    createSession(text);
    closeModal(els.addSessionModal);
  };
  els.newSessionInput.onkeydown = (e) => {
    if (e.key === "Enter") els.confirmAddSessionBtn.click();
  };

  // Add Exercises
  els.openAddExerciseModalBtn.onclick = () => {
    els.newExerciseInput.value = "";
    openModal(els.addExerciseModal);
  };
  els.confirmAddExerciseBtn.onclick = () => {
    const raw = els.newExerciseInput.value;
    if (!raw.trim()) return;
    addExercisesFromPaste(raw);
    closeModal(els.addExerciseModal);
  };

  // Back
  function goHome() {
    state.activeSessionId = null;
    saveState();
    render();
  }
  els.backBtn.onclick = goHome;
  els.backBtn.onkeydown = (e) => { if (e.key === "Enter") goHome(); };

  // Filters
  function setSessionFilter(filter, btnId) {
    state.ui.sessionFilter = filter;
    setChipGroup("session", btnId);
    saveState();
    renderHome();
  }
  els.sessionFilterAll.onclick = () => setSessionFilter("all", "sessionFilterAll");
  els.sessionFilterActive.onclick = () => setSessionFilter("active", "sessionFilterActive");
  els.sessionFilterDone.onclick = () => setSessionFilter("done", "sessionFilterDone");

  function setExFilter(filter, btnId) {
    state.ui.exFilter = filter;
    setChipGroup("ex", btnId);
    saveState();
    renderDetail();
  }
  els.exFilterAll.onclick = () => setExFilter("all", "exFilterAll");
  els.exFilterActive.onclick = () => setExFilter("active", "exFilterActive");
  els.exFilterDone.onclick = () => setExFilter("done", "exFilterDone");

  els.sessionSearch.addEventListener("input", () => {
    state.ui.sessionQuery = els.sessionSearch.value;
    saveState();
    renderHome();
  });
  els.exerciseSearch.addEventListener("input", () => {
    state.ui.exQuery = els.exerciseSearch.value;
    saveState();
    renderDetail();
  });

  // Detail actions
  els.renameSessionBtn.onclick = () => renameSession(state.activeSessionId);
  els.duplicateSessionBtn.onclick = () => duplicateSession(state.activeSessionId);
  els.deleteSessionBtn.onclick = () => deleteSession(state.activeSessionId);

  els.markAllDoneBtn.onclick = () => {
    const s = getActiveSession();
    if (!s) return;
    if (!Array.isArray(s.exercises) || s.exercises.length === 0) return;
    s.exercises.forEach(e => e.done = true);
    s.done = true;
    saveState();
    render();
    toast("Marked all done");
  };

  els.clearDoneBtn.onclick = () => {
    const s = getActiveSession();
    if (!s) return;
    const before = (s.exercises || []).length;
    s.exercises = (s.exercises || []).filter(e => !e.done);
    const removed = before - s.exercises.length;
    s.done = s.exercises.length > 0 && s.exercises.every(x => x.done);
    saveState();
    render();
    if (removed) toast(`Removed ${removed} completed`);
  };

  // Confirm modal
  els.confirmCancelBtn.onclick = () => { closeModal(els.confirmModal); confirmAction = null; };
  els.confirmOkBtn.onclick = () => { if (typeof confirmAction === "function") confirmAction(); };

  // Export / Import
  els.exportBtn.onclick = exportBackup;
  els.importBtn.onclick = () => els.importFile.click();
  els.importFile.onchange = () => importBackupFromFile(els.importFile.files?.[0]);

  // Reset
  els.clearAllBtn.onclick = () => {
    showConfirm({
      text: "Reset ALL data on this device? (Sessions, exercises, name)",
      okText: "Reset",
      danger: true,
      onOk: () => {
        state = {
          name: "Athlete",
          activeSessionId: null,
          sessions: [],
          ui: { sessionFilter: "all", sessionQuery: "", exFilter: "all", exQuery: "" }
        };
        saveState();
        render();
        closeModal(els.confirmModal);
        toast("Reset complete");
      }
    });
  };

  // Restore UI chips on load
  function restoreChips() {
    const sf = state.ui.sessionFilter || "all";
    setChipGroup("session", sf === "active" ? "sessionFilterActive" : sf === "done" ? "sessionFilterDone" : "sessionFilterAll");

    const ef = state.ui.exFilter || "all";
    setChipGroup("ex", ef === "active" ? "exFilterActive" : ef === "done" ? "exFilterDone" : "exFilterAll");
  }

  // Init
  loadState();
  restoreChips();
  render();
})();
</script>
</body>
</html>
